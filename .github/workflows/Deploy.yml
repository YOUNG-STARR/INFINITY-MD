const config = require('../config');
const { cmd } = require('../command');

function parseDuration(value, unit) {
    const multipliers = {
        second: 1000,
        seconds: 1000,
        minute: 60000,
        minutes: 60000,
        hour: 3600000,
        hours: 3600000,
        day: 86400000,
        days: 86400000
    };
    if (isNaN(value)) return null;
    return multipliers[unit.toLowerCase()] ? parseInt(value) * multipliers[unit.toLowerCase()] : null;
}

cmd({
    pattern: "opentime",
    react: "ğŸ”“",
    desc: "Temporarily open the group for a specific time",
    category: "group",
    use: ".opentime 10 minutes",
    filename: __filename
}, async (conn, mek, m, { from, args, isGroup, isAdmins, reply }) => {
    try {
        if (!isGroup) return reply("âŒ This command can only be used in groups.");
        if (!isAdmins) return reply("âŒ Only group admins can use this command.");

        const timer = parseDuration(args[0], args[1]);
        if (!timer) return reply(
            `*âš ï¸ Invalid duration!*\n\nğŸ•’ *Valid units:* seconds, minutes, hours, days\nğŸ“Œ *Example:* .opentime 10 minutes`
        );

        await conn.groupSettingUpdate(from, 'not_announcement');
        reply(
            `ğŸ”“ *Group is now OPEN for* ${args[0]} ${args[1]}!\n\nğŸ’¬ All members can send messages.\n\nâ•­â”€â– ã€Œ *INFINITY-MD* ã€\nâ”‚   Powered by SIRIUS\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯`
        );

        setTimeout(async () => {
            await conn.groupSettingUpdate(from, 'announcement');
            await conn.sendMessage(from, {
                text: `ğŸ” *TIME'S UP!*\n\nğŸ”‡ Group is now CLOSED.\nOnly admins can send messages.\n\nâ•­â”€â– ã€Œ *INFINITY-MD* ã€\nâ”‚   Powered by SIRIUS\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯`,
            });
        }, timer);

        await conn.sendMessage(from, { react: { text: `âœ…`, key: mek.key } });
    } catch (e) {
        reply("âŒ An error occurred while opening the group.");
        console.error(e);
    }
});

cmd({
    pattern: "closetime",
    react: "ğŸ”",
    desc: "Temporarily close the group for a specific time",
    category: "group",
    use: ".closetime 10 minutes",
    filename: __filename
}, async (conn, mek, m, { from, args, isGroup, isAdmins, reply }) => {
    try {
        if (!isGroup) return reply("âŒ This command can only be used in groups.");
        if (!isAdmins) return reply("âŒ Only group admins can use this command.");

        const timer = parseDuration(args[0], args[1]);
        if (!timer) return reply(
            `*âš ï¸ Invalid duration!*\n\nğŸ•’ *Valid units:* seconds, minutes, hours, days\nğŸ“Œ *Example:* .closetime 5 minutes`
        );

        await conn.groupSettingUpdate(from, 'announcement');
        reply(
            `ğŸ” *Group is now CLOSED for* ${args[0]} ${args[1]}!\n\nğŸš« Only admins can send messages.\n\nâ•­â”€â– ã€Œ *INFINITY-MD* ã€\nâ”‚   Powered by SIRIUS\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯`
        );

        setTimeout(async () => {
            await conn.groupSettingUpdate(from, 'not_announcement');
            await conn.sendMessage(from, {
                text: `ğŸ”“ *TIME'S UP!*\n\nğŸ’¬ Group is now OPEN. Everyone can send messages.\n\nâ•­â”€â– ã€Œ *INFINITY-MD* ã€\nâ”‚   Powered by SIRIUS\nâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯`,
            });
        }, timer);

        await conn.sendMessage(from, { react: { text: `âœ…`, key: mek.key } });
    } catch (e) {
        reply("âŒ An error occurred while closing the group.");
        console.error(e);
    }
});
